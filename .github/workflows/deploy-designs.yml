name: Build and Deploy to gh-pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout main
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Build all variants and push to gh-pages
      run: |
        set -e
        
        # Config git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        ROOT="$PWD"
        BRANCHES=("main" "old-design" "professional-design" "minimalist-design")
        rm -rf combined release_build
        mkdir -p combined
        
        for BR in "${BRANCHES[@]}"; do
          echo "=== Building $BR ==="
          git fetch origin "$BR" --depth=1
          git checkout FETCH_HEAD
          
          dotnet publish SPVetClinic/SPVetClinic.csproj -c Release -o release_build --nologo
          
          if [ "$BR" = "main" ]; then
            DEST_PATH="$ROOT/combined"
          else
            DEST_PATH="$ROOT/combined/$BR"
            mkdir -p "$DEST_PATH"
          fi
          
          # Copy published files
          if [ "$DEST_PATH" = "$ROOT/combined" ]; then
            cp -r release_build/wwwroot/* "$DEST_PATH/"
          else
            cp -r release_build/wwwroot/* "$DEST_PATH/"
          fi
          
          rm -rf release_build
        done
        
        touch combined/.nojekyll
        echo "Build complete. Contents:"
        ls -la combined/
        
        # Push to gh-pages
        git fetch origin gh-pages --depth=1 || true
        git checkout --orphan gh-pages-new
        rm -rf .git/index
        git reset
        cp -r combined/* .
        git add .
        git commit -m "Deploy: build all variants $(date)" || true
        git branch -D gh-pages || true
        git branch -m gh-pages-new gh-pages
        git push origin gh-pages -f
