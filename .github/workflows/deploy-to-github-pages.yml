name: Deploy Blazor WASM to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Publish
      run: dotnet publish SPVetClinic/SPVetClinic.csproj -c Release -o release --nologo
      
    - name: Change base tag in index.html
      run: |
        sed -i 's|<base href="/" />|<base href="/${{ github.event.repository.name }}/" />|g' release/wwwroot/index.html
    
    - name: Fix blazor.webassembly.js reference and remove integrity
      run: |
        cd release/wwwroot
        # Find the actual blazor.webassembly file with fingerprint
        BLAZOR_FILE=$(ls _framework/blazor.webassembly*.js | head -1 | xargs basename)
        echo "Found Blazor file: $BLAZOR_FILE"
        
        # Replace the placeholder with actual filename and remove integrity attribute
        sed -i "s|blazor.webassembly#\[\.{fingerprint}\]\.js|$BLAZOR_FILE|g" index.html
        sed -i 's| integrity="[^"]*"||g' index.html
        
    - name: Fix dotnet.js reference
      run: |
        cd release/wwwroot/_framework
        # Find the actual dotnet.*.js file
        DOTNET_FILE=$(ls dotnet.*.js | grep -v ".map" | grep -v ".symbols" | head -1)
        if [ ! -z "$DOTNET_FILE" ]; then
          echo "Found dotnet file: $DOTNET_FILE"
          # Create dotnet.js that imports the fingerprinted version
          echo "export * from './$DOTNET_FILE';" > dotnet.js
        fi
        
    - name: Remove invalid preload and fix integrity issues
      run: |
        cd release/wwwroot
        # Remove the preload link that causes warnings
        sed -i '/<link rel="preload" id="webassembly"/d' index.html
        # Remove all integrity attributes to prevent mismatches
        sed -i 's| integrity="[^"]*"||g' index.html
        
    - name: Generate proper importmap
      run: |
        cd release/wwwroot
        # Create a simple importmap without fingerprints for imports
        cat > temp_importmap.json << 'EOF'
        {
          "imports": {
            "dotnet": "./_framework/dotnet.js"
          }
        }
        EOF
        
        # Insert the importmap into index.html
        sed -i 's|<script type="importmap"></script>|<script type="importmap">\n'"$(cat temp_importmap.json | sed 's/$/\\n/' | tr -d '\n')"'\n</script>|g' index.html
        rm temp_importmap.json
    
    - name: Create 404.html with SPA redirect for GitHub Pages
      run: |
        cd release/wwwroot
        cat > 404.html << 'EOF'
        <!DOCTYPE html>
        <html lang="es">
        <head>
          <meta charset="utf-8" />
          <title>Redirigiendo...</title>
          <script>
            // GitHub Pages SPA redirect solution for Blazor
            // This script captures the 404 path and redirects to index.html with path as query parameter
            (function() {
              var pathSegmentsToKeep = 1; // Keep "/SPVetClinic" in the path
              
              var location = window.location;
              var redirect = location.protocol + '//' + location.hostname + 
                            (location.port ? ':' + location.port : '') +
                            location.pathname.split('/').slice(0, 1 + pathSegmentsToKeep).join('/') + 
                            '/?/' + 
                            location.pathname.slice(1).split('/').slice(pathSegmentsToKeep).join('/').replace(/&/g, '~and~') +
                            (location.search ? '&' + location.search.slice(1).replace(/&/g, '~and~') : '') +
                            location.hash;
              
              window.location.replace(redirect);
            })();
          </script>
        </head>
        <body>
          <p>Redirigiendo...</p>
        </body>
        </html>
        EOF
        
    - name: Add SPA redirect handler to index.html
      run: |
        cd release/wwwroot
        # Add script right after <base> tag to handle redirected paths from 404.html
        sed -i '/<base href=/a\    <script>\n      // Handle redirected paths from 404.html\n      (function(l) {\n        if (l.search[1] === "/" ) {\n          var decoded = l.search.slice(1).split("&").map(function(s) { \n            return s.replace(/~and~/g, "&")\n          }).join("?");\n          window.history.replaceState(null, null,\n            l.pathname.slice(0, -1) + decoded + l.hash\n          );\n        }\n      }(window.location))\n    </script>' index.html
    
    - name: Add .nojekyll file
      run: touch release/wwwroot/.nojekyll
      
    - name: Setup Pages
      uses: actions/configure-pages@v5
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'release/wwwroot'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
