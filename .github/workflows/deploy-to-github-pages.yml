name: Deploy Blazor WASM to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Publish
      run: dotnet publish SPVetClinic/SPVetClinic.csproj -c Release -o release --nologo
      
    - name: Change base tag in index.html
      run: |
        sed -i 's|<base href="/" />|<base href="/${{ github.event.repository.name }}/" />|g' release/wwwroot/index.html
    
    - name: Fix blazor.webassembly.js reference and remove integrity
      run: |
        cd release/wwwroot
        # Find the actual blazor.webassembly file with fingerprint
        BLAZOR_FILE=$(ls _framework/blazor.webassembly*.js | head -1 | xargs basename)
        echo "Found Blazor file: $BLAZOR_FILE"
        
        # Replace the placeholder with actual filename and remove integrity attribute
        sed -i "s|blazor.webassembly#\[\.{fingerprint}\]\.js|$BLAZOR_FILE|g" index.html
        sed -i 's| integrity="[^"]*"||g' index.html
        
    - name: Fix dotnet.js reference
      run: |
        cd release/wwwroot/_framework
        # Find the actual dotnet.*.js file
        DOTNET_FILE=$(ls dotnet.*.js | grep -v ".map" | grep -v ".symbols" | head -1)
        if [ ! -z "$DOTNET_FILE" ]; then
          echo "Found dotnet file: $DOTNET_FILE"
          # Create dotnet.js that imports the fingerprinted version
          echo "export * from './$DOTNET_FILE';" > dotnet.js
        fi
        
    - name: Remove invalid preload and fix integrity issues
      run: |
        cd release/wwwroot
        # Remove the preload link that causes warnings
        sed -i '/<link rel="preload" id="webassembly"/d' index.html
        # Remove all integrity attributes to prevent mismatches
        sed -i 's| integrity="[^"]*"||g' index.html
        
    - name: Generate proper importmap
      run: |
        cd release/wwwroot
        # Create a simple importmap without fingerprints for imports
        cat > temp_importmap.json << 'EOF'
        {
          "imports": {
            "dotnet": "./_framework/dotnet.js"
          }
        }
        EOF
        
        # Insert the importmap into index.html
        sed -i 's|<script type="importmap"></script>|<script type="importmap">\n'"$(cat temp_importmap.json | sed 's/$/\\n/' | tr -d '\n')"'\n</script>|g' index.html
        rm temp_importmap.json
    
    - name: Fix Blazor internal routes in compiled DLLs
      run: |
        cd release/wwwroot/_framework
        # Fix NavigationManager base paths in all .dll files
        # This ensures Blazor routing works correctly with the base href
        for file in *.dll; do
          if [ -f "$file" ]; then
            # Replace references to root path in compiled assemblies
            sed -i 's|href="/|href="/${{ github.event.repository.name }}/|g' "$file" 2>/dev/null || true
          fi
        done
        
    - name: Copy index.html to 404.html for SPA routing
      run: cp release/wwwroot/index.html release/wwwroot/404.html
      
    - name: Add .nojekyll file
      run: touch release/wwwroot/.nojekyll
      
    - name: Setup Pages
      uses: actions/configure-pages@v5
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'release/wwwroot'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
