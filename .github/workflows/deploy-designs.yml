name: Build and Deploy to gh-pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout main
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Build all variants and push to gh-pages
      run: |
        set -e
        
        # Config git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        ROOT="$PWD"
        BRANCHES=("main" "old-design" "professional-design" "minimalist-design")
        REPO_NAME="SPVetClinic"
        rm -rf combined release_build
        mkdir -p combined
        
        for BR in "${BRANCHES[@]}"; do
          echo "=== Building $BR ==="
          git fetch origin "$BR" --depth=1
          git checkout FETCH_HEAD
          
          dotnet publish SPVetClinic/SPVetClinic.csproj -c Release -o release_build --nologo
          
          if [ "$BR" = "main" ]; then
            BASE_HREF="/$REPO_NAME/"
            DEST_PATH="$ROOT/combined"
          else
            BASE_HREF="/$REPO_NAME/$BR/"
            DEST_PATH="$ROOT/combined/$BR"
            mkdir -p "$DEST_PATH"
          fi
          
          echo "Setting base href to: $BASE_HREF"
          sed -i "s|<base href=\"/\" />|<base href=\"$BASE_HREF\" />|g" release_build/wwwroot/index.html
          
          # Copy published files
          cp -r release_build/wwwroot/* "$DEST_PATH/"
          
          # Create 404.html for SPA routing in this variant
          cat > "$DEST_PATH/404.html" << 'EOF'
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"/></head>
<body>
<script>
var l=window.location;l.replace(l.protocol+'//'
+l.hostname+(l.port?':'+l.port:'')+l.pathname.split('/').slice(0,3).join('/')
+'/?/'+l.pathname.slice(1).split('/').slice(2).join('/').replace(/&/g,'~and~')
+(l.search?'&'+l.search.slice(1).replace(/&/g,'~and~'):'')
+l.hash);
</script>
</body>
</html>
EOF
          
          rm -rf release_build
        done
        
        touch combined/.nojekyll
        echo "Build complete. Structure:"
        find combined -maxdepth 2 -type f -name "index.html" -o -name "404.html" | sort
        
        # Push to gh-pages
        echo "Pushing to gh-pages..."
        git fetch origin gh-pages --depth=1 2>/dev/null || echo "gh-pages not found, will create"
        git checkout --orphan gh-pages-temp
        git rm -rf .
        cp -r combined/* .
        git add .
        git commit -m "Deploy: build all variants - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "Nothing to commit"
        git branch -D gh-pages 2>/dev/null || true
        git branch -m gh-pages-temp gh-pages
        git push origin gh-pages -f
        echo "Pushed to gh-pages successfully"
